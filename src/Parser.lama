-- Parser 

import Ostap;
import Lexer;
import List;
import Fun;
import Matcher;

-- A parser of "something" in brackets; l, r are left and right
-- brackets as parsers, p --- a parser of "something"
fun inbr (l, p, r) {
  syntax (-l p -r)
}



fun stropToBinop(l, op, r) {
  Binop(op, l, r)
}



var primary = memo $ eta syntax (x=decimal {Const (stringInt (x))} |
                                 x=lident  {Var (x)}               |
                                 inbr[s("("), exp, s(")")]),
      exp = memo $ expr (
        {
          [Left, {[s("&&") | s("!!"), stropToBinop]}],
          [Left, {[s(">=") | s("==") | s("<=") | s ("!=") | s(">") | s("<"), stropToBinop]}],
          [Left, {[s("+") | s("-"), stropToBinop]}],
          [Left, {[s("*") | s("/") | s("%"), stropToBinop]}]
        }, primary
      );


var sngl = memo $ eta syntax (
  kRead x=inbr[s("("), lident, s(")")] {Read(x)}       |
  kWrite x=inbr[s("("), exp, s(")")] {Write(x)}        |
  kSkip {Skip}                                         |
  x=lident s[":="] v=exp {Assn(x, v)}
);
var nonEndStmt = memo $ eta syntax (st=sngl {st} | le=sngl s[";"] ri=nonEndStmt {Seq(le, ri)});
var stmt = memo $ eta syntax (a=nonEndStmt {a});

-- Public top-level parser
public parse = stmt;
